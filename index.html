<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador Apalancado</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #f5b041;
      text-shadow: 0 0 5px rgba(245, 176, 65, 0.4);
    }
    .form-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .form-group {
      background: #1a1a1a;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(245, 176, 65, 0.05);
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ccc;
    }
    input {
      width: 100%;
      padding: 10px;
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      color: #fff;
      font-size: 15px;
    }
    .auto-input {
      width: auto;
      max-width: 120px;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      color: #fff;
      font-size: 14px;
    }
    button {
      padding: 12px 30px;
      background: linear-gradient(90deg, #444, #222);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #333;
    }
    tr.highlight {
      background: #1e1e1e;
      font-weight: bold;
    }
    .diferencia {
      font-weight: bold;
    }
    .positivo {
      color: #4caf50;
    }
    .negativo {
      color: #e74c3c;
    }
    .neutro {
      color: #aaa;
    }
    #contador-operaciones {
      font-size: 18px;
      margin-top: 4px;
      font-weight: bold;
      color: #f5b041;
    }
  </style>
</head>
<body>

<h1>Simulador Apalancado</h1>

<div class="form-container">
  <div class="form-group">
    <label for="capital">Capital Inicial ($):</label>
    <input type="number" id="capital" placeholder="Ej: 100">
    <label>Operaciones:</label>
    <div id="contador-operaciones">0 / 0</div>
  </div>
  <div class="form-group">
    <label for="meta">Meta Final ($):</label>
    <input type="number" id="meta" placeholder="Ej: 1000">
  </div>
  <div class="form-group">
    <label for="ganancia">Ganancia por Trade (%):</label>
    <input type="number" id="ganancia" placeholder="Ej: 8">
  </div>
  <div class="form-group">
    <label for="apalancamiento">Apalancamiento:</label>
    <input type="number" id="apalancamiento" placeholder="Ej: 20">
  </div>
</div>

<div style="text-align:center;">
  <button onclick="simular()">Simular</button>
</div>

<table id="tabla">
  <thead>
    <tr>
      <th>#</th>
      <th>Capital ($)</th>
      <th>Ganancia (%)</th>
      <th>Ganancia ($)</th>
      <th>Total Simulado ($)</th>
      <th>Total Alcanzado ($)</th>
      <th>Diferencia ($)</th>
      <th>Inversión × Apalancamiento ($)</th>
      <th>Tipo</th>
      <th>Precio Entrada</th>
      <th>Precio Salida</th>
      <th>Precio Liquidación</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let datosOriginales = [];

function calcularLiquidacion(precioEntrada, apalancamiento, tipo) {
  const margen = 1 / apalancamiento;
  const fee = 0.005;
  const riesgo = margen + fee;
  return tipo === "long"
    ? precioEntrada * (1 - riesgo)
    : precioEntrada * (1 + riesgo);
}

function calcularSalida(precioEntrada, apalancamiento, ganancia, tipo) {
  const cambio = (ganancia / 100) / apalancamiento;
  return tipo === "long"
    ? precioEntrada * (1 + cambio)
    : precioEntrada * (1 - cambio);
}

function simular(capitalInicialManual = null, filaInicio = 1) {
  const capitalInicial = capitalInicialManual ?? parseFloat(document.getElementById("capital").value);
  const meta = parseFloat(document.getElementById("meta").value);
  const gananciaPorcentaje = parseFloat(document.getElementById("ganancia").value);
  const apalancamiento = parseFloat(document.getElementById("apalancamiento").value);

  if (isNaN(capitalInicial) || isNaN(meta) || isNaN(gananciaPorcentaje) || isNaN(apalancamiento)) {
    alert("Por favor, completa todos los campos.");
    return;
  }

  let capital = capitalInicial;
  let fila = filaInicio;
  let tbody = document.querySelector("#tabla tbody");

  if (filaInicio === 1) {
    tbody.innerHTML = "";
    datosOriginales = [];
  }

  while (capital < meta) {
    const ganancia = capital * (gananciaPorcentaje / 100);
    const total = capital + ganancia;
    const inversion = capital * apalancamiento;

    datosOriginales.push({ capital, ganancia, total, inversion });

    const row = document.createElement("tr");
    if (total >= meta) row.classList.add("highlight");

    row.innerHTML = `
      <td>${fila}</td>
      <td class="capital">$${capital.toFixed(2)}</td>
      <td>${gananciaPorcentaje}%</td>
      <td class="ganancia">$${ganancia.toFixed(2)}</td>
      <td class="total-simulado">$${total.toFixed(2)}</td>
      <td><input class="auto-input total-alcanzado" type="number" step="0.01" placeholder="-"></td>
      <td class="diferencia neutro">-</td>
      <td class="inversion">$${inversion.toFixed(2)}</td>
      <td>
        <select class="tipo-op">
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </td>
      <td><input class="auto-input precio-entrada" type="number" step="0.0001" placeholder="Ej: 1.2300"></td>
      <td class="precio-salida">-</td>
      <td class="precio-liquidacion">-</td>
    `;

    tbody.appendChild(row);
    fila++;
    capital = total;
  }

  document.getElementById("contador-operaciones").textContent = `${fila - 1} / ${fila - 1}`;
  agregarEventos(gananciaPorcentaje, apalancamiento);
  guardarEstado();
}

function agregarEventos(gananciaPorcentaje, apalancamiento) {
  const filas = document.querySelectorAll("#tabla tbody tr");

  filas.forEach((fila, i) => {
    const tipoSelect = fila.querySelector(".tipo-op");
    const entradaInput = fila.querySelector(".precio-entrada");
    const alcanzadoInput = fila.querySelector(".total-alcanzado");
    const diferenciaCell = fila.querySelector(".diferencia");
    const totalSimulado = parseFloat(fila.querySelector(".total-simulado").textContent.replace("$", ""));

    const actualizarPrecios = () => {
      const tipo = tipoSelect.value;
      const entrada = parseFloat(entradaInput.value);
      const salidaCell = fila.querySelector(".precio-salida");
      const liquiCell = fila.querySelector(".precio-liquidacion");

      if (!isNaN(entrada) && entrada > 0) {
        const salida = calcularSalida(entrada, apalancamiento, gananciaPorcentaje, tipo);
        const liqui = calcularLiquidacion(entrada, apalancamiento, tipo);
        salidaCell.textContent = `$${salida.toFixed(4)}`;
        liquiCell.textContent = `$${liqui.toFixed(4)}`;
      } else {
        salidaCell.textContent = "-";
        liquiCell.textContent = "-";
      }
      guardarEstado();
    };

    const actualizarDiferencia = () => {
      const valor = parseFloat(alcanzadoInput.value);
      if (isNaN(valor)) {
        diferenciaCell.textContent = "-";
        diferenciaCell.className = "diferencia neutro";
        return;
      }
      const diff = valor - totalSimulado;
      diferenciaCell.textContent = (diff >= 0 ? "+" : "") + "$" + diff.toFixed(2);
      diferenciaCell.className = "diferencia " + (diff > 0 ? "positivo" : diff < 0 ? "negativo" : "neutro");
      guardarEstado();
    };

    tipoSelect.addEventListener("change", actualizarPrecios);
    entradaInput.addEventListener("input", actualizarPrecios);
    alcanzadoInput.addEventListener("change", () => {
      const nuevoValor = parseFloat(alcanzadoInput.value);
      const nuevoCapital = !isNaN(nuevoValor) ? nuevoValor : totalSimulado;

      actualizarDiferencia();

      const tbody = document.querySelector("#tabla tbody");
      const siguientes = Array.from(tbody.querySelectorAll("tr")).slice(i + 1);
      siguientes.forEach(tr => tr.remove());
      datosOriginales.splice(i + 1);

      simular(nuevoCapital, i + 2);
    });
  });
}

function guardarEstado() {
  const filas = document.querySelectorAll("#tabla tbody tr");
  const estado = {
    capital: document.getElementById("capital").value,
    meta: document.getElementById("meta").value,
    ganancia: document.getElementById("ganancia").value,
    apalancamiento: document.getElementById("apalancamiento").value,
    totalOperaciones: filas.length,
    filas: Array.from(filas).map(fila => ({
      totalAlcanzado: fila.querySelector(".total-alcanzado").value,
      tipo: fila.querySelector(".tipo-op").value,
      precioEntrada: fila.querySelector(".precio-entrada").value,
      diferencia: fila.querySelector(".diferencia").textContent,
      diferenciaClass: fila.querySelector(".diferencia").className
    }))
  };
  localStorage.setItem("estadoSimulador", JSON.stringify(estado));
}

function cargarEstado() {
  const guardado = localStorage.getItem("estadoSimulador");
  if (!guardado) return;
  const estado = JSON.parse(guardado);

  document.getElementById("capital").value = estado.capital;
  document.getElementById("meta").value = estado.meta;
  document.getElementById("ganancia").value = estado.ganancia;
  document.getElementById("apalancamiento").value = estado.apalancamiento;
  document.getElementById("contador-operaciones").textContent = `${estado.totalOperaciones} / ${estado.totalOperaciones}`;

  simular(parseFloat(estado.capital));

  estado.filas.forEach((fila, i) => {
    const tr = document.querySelectorAll("#tabla tbody tr")[i];
    if (!tr) return;

    tr.querySelector(".total-alcanzado").value = fila.totalAlcanzado;
    tr.querySelector(".tipo-op").value = fila.tipo;
    tr.querySelector(".precio-entrada").value = fila.precioEntrada;

    const entrada = parseFloat(fila.precioEntrada);
    const tipo = fila.tipo;
    const salidaCell = tr.querySelector(".precio-salida");
    const liquiCell = tr.querySelector(".precio-liquidacion");

    if (!isNaN(entrada) && entrada > 0) {
      const salida = calcularSalida(entrada, parseFloat(estado.apalancamiento), parseFloat(estado.ganancia), tipo);
      const liqui = calcularLiquidacion(entrada, parseFloat(estado.apalancamiento), tipo);
      salidaCell.textContent = `$${salida.toFixed(4)}`;
      liquiCell.textContent = `$${liqui.toFixed(4)}`;
    } else {
      salidaCell.textContent = "-";
      liquiCell.textContent = "-";
    }

    const diferencia = tr.querySelector(".diferencia");
    diferencia.textContent = fila.diferencia;
    diferencia.className = fila.diferenciaClass;
  });
}

window.onload = cargarEstado;
</script>

</body>
</html>
