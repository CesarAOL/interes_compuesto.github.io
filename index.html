<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador Apalancado</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #f5b041;
      text-shadow: 0 0 5px rgba(245, 176, 65, 0.4);
    }
    .form-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .form-group {
      background: #1a1a1a;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(245, 176, 65, 0.05);
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ccc;
    }
    input {
      width: 100%;
      padding: 10px;
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      color: #fff;
      font-size: 15px;
    }
    .auto-input {
      width: auto;
      max-width: 120px;
      box-sizing: border-box;
      padding: 6px 8px;
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      color: #fff;
      font-size: 14px;
    }
    button {
      padding: 12px 30px;
      background: linear-gradient(90deg, #444, #222);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #333;
    }
tr.highlight {
  background: #398003 !important;  /* verde lima suave */
  color: #111 !important;          /* texto oscuro para buen contraste */
  font-weight: bold;
  box-shadow: 0 0 1px #377506;   /* sombra suave */
  transition: background 0.3s ease;
}
    .diferencia {
      font-weight: bold;
    }
    .positivo {
      color: #4caf50;
    }
    .negativo {
      color: #e74c3c;
    }
    .neutro {
      color: #aaa;
    }
  </style>
</head>
<body>

<h1>Simulador Apalancado</h1>

<div class="form-container">
  <div class="form-group">
    <label for="capital">Capital Inicial ($):</label>
    <input type="number" id="capital" placeholder="Ej: 100">
  </div>
  <div class="form-group">
    <label for="meta">Meta Final ($):</label>
    <input type="number" id="meta" placeholder="Ej: 1000">
  </div>
  <div class="form-group">
    <label for="ganancia">Ganancia por Trade (%):</label>
    <input type="number" id="ganancia" placeholder="Ej: 8">
  </div>
  <div class="form-group">
    <label for="apalancamiento">Apalancamiento:</label>
    <input type="number" id="apalancamiento" placeholder="Ej: 20">
  </div>
</div>

<!-- Fila horizontal: Totales, Realizadas, Simular -->
<div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
<!-- Total Alcanzado -->
<div style="background: #1e1e1e; padding: 15px 25px; border-radius: 10px; box-shadow: 0 0 8px rgba(255,255,255,0.05); text-align: center; width: 220px;">
  <div style="font-size: 16px; color: #aaa; margin-bottom: 5px;">Total Alcanzado ($)</div>
  <div id="totalAlcanzadoSum" style="font-size: 24px; color: #f5b041; font-weight: bold;">$0.00</div>
</div>

<!-- Operaciones Totales -->
<div style="background: #1e1e1e; padding: 15px 25px; border-radius: 10px; box-shadow: 0 0 8px rgba(255,255,255,0.05); text-align: center; width: 220px;">
  <div style="font-size: 16px; color: #aaa; margin-bottom: 5px;">Operaciones Totales</div>
  <div id="contadorTotal" style="font-size: 24px; color: #f5b041; font-weight: bold;">0</div>
</div>


  <!-- Operaciones Realizadas -->
  <div style="background: #1e1e1e; padding: 15px 25px; border-radius: 10px; box-shadow: 0 0 8px rgba(255,255,255,0.05); text-align: center; width: 220px;">
    <div style="font-size: 16px; color: #aaa; margin-bottom: 5px;">Operaciones Realizadas</div>
    <div id="contadorRealizadas" style="font-size: 24px; color: #4caf50; font-weight: bold;">0</div>
  </div>

  <!-- Botón Simular -->
  <div>
    <button style="font-size: 17px; padding: 14px 32px;" onclick="simular()">Simular</button>
  </div>

</div>


<table id="tabla">
  <thead>
    <tr>
      <th>#</th>
      <th>Capital ($)</th>
      <th>Ganancia (%)</th>
      <th>Ganancia ($)</th>
      <th>Total Simulado ($)</th>
      <th>Total Alcanzado ($)</th>
      <th>Diferencia ($)</th>
      <th>Inversión × Apalancamiento ($)</th>
      <th>Tipo</th>
      <th>Precio Entrada</th>
      <th>Precio Salida</th>
      <th>Precio Liquidación</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
function calcularLiquidacion(precioEntrada, apalancamiento, tipo) {
  const margen = 1 / apalancamiento;
  const fee = 0.005;
  const riesgo = margen + fee;
  return tipo === "long"
    ? precioEntrada * (1 - riesgo)
    : precioEntrada * (1 + riesgo);
}

function calcularSalida(precioEntrada, apalancamiento, ganancia, tipo) {
  const cambio = (ganancia / 100) / apalancamiento;
  return tipo === "long"
    ? precioEntrada * (1 + cambio)
    : precioEntrada * (1 - cambio);
}

function simular(capitalInicialManual = null, filaInicio = 1) {
  const capitalInicial = capitalInicialManual ?? parseFloat(document.getElementById("capital").value);
  const meta = parseFloat(document.getElementById("meta").value);
  const gananciaPorcentaje = parseFloat(document.getElementById("ganancia").value);
  const apalancamiento = parseFloat(document.getElementById("apalancamiento").value);

  if (isNaN(capitalInicial) || isNaN(meta) || isNaN(gananciaPorcentaje) || isNaN(apalancamiento)) {
    alert("Por favor, completa todos los campos.");
    return;
  }

  let capital = capitalInicial;
  let fila = filaInicio;
  let tbody = document.querySelector("#tabla tbody");

  if (filaInicio === 1) tbody.innerHTML = "";

  while (capital < meta) {
    const ganancia = capital * (gananciaPorcentaje / 100);
    const total = capital + ganancia;
    const inversion = capital * apalancamiento;

    const row = document.createElement("tr");
    if (total >= meta) row.classList.add("highlight");

    row.innerHTML = `
      <td>${fila}</td>
      <td class="capital">$${capital.toFixed(2)}</td>
      <td>${gananciaPorcentaje}%</td>
      <td class="ganancia">$${ganancia.toFixed(2)}</td>
      <td class="total-simulado">$${total.toFixed(2)}</td>
      <td><input class="auto-input total-alcanzado" type="number" step="0.01" placeholder="-"></td>
      <td class="diferencia neutro">-</td>
      <td class="inversion">$${inversion.toFixed(2)}</td>
      <td>
        <select class="tipo-op">
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </td>
      <td><input class="auto-input precio-entrada" type="number" step="0.0001" placeholder="Ej: 1.2300"></td>
      <td class="precio-salida">-</td>
      <td class="precio-liquidacion">-</td>
    `;

    tbody.appendChild(row);
    agregarEventos(fila - 1, gananciaPorcentaje, apalancamiento);
    fila++;
    capital = total;
  }

  guardarEstado();
  actualizarContadores();
}

function agregarEventos(index, gananciaPorcentaje, apalancamiento) {
  const fila = document.querySelectorAll("#tabla tbody tr")[index];
  const tipoSelect = fila.querySelector(".tipo-op");
  const entradaInput = fila.querySelector(".precio-entrada");
  const alcanzadoInput = fila.querySelector(".total-alcanzado");
  const diferenciaCell = fila.querySelector(".diferencia");
  const totalSimulado = parseFloat(fila.querySelector(".total-simulado").textContent.replace("$", ""));

  const actualizarPrecios = () => {
    const tipo = tipoSelect.value;
    const entrada = parseFloat(entradaInput.value);
    const salidaCell = fila.querySelector(".precio-salida");
    const liquiCell = fila.querySelector(".precio-liquidacion");

    if (!isNaN(entrada) && entrada > 0) {
      const salida = calcularSalida(entrada, apalancamiento, gananciaPorcentaje, tipo);
      const liqui = calcularLiquidacion(entrada, apalancamiento, tipo);
      salidaCell.textContent = `$${salida.toFixed(4)}`;
      liquiCell.textContent = `$${liqui.toFixed(4)}`;
    } else {
      salidaCell.textContent = "-";
      liquiCell.textContent = "-";
    }
    guardarEstado();
  };

  const actualizarDiferencia = () => {
    const valor = parseFloat(alcanzadoInput.value);
    if (isNaN(valor)) {
      diferenciaCell.textContent = "-";
      diferenciaCell.className = "diferencia neutro";
      return;
    }
    const diff = valor - totalSimulado;
    diferenciaCell.textContent = (diff >= 0 ? "+" : "") + "$" + diff.toFixed(2);
    diferenciaCell.className = "diferencia " + (diff > 0 ? "positivo" : diff < 0 ? "negativo" : "neutro");
    guardarEstado();
  };

  tipoSelect.addEventListener("change", actualizarPrecios);
  entradaInput.addEventListener("input", actualizarPrecios);
  alcanzadoInput.addEventListener("change", () => {
    const nuevoValor = parseFloat(alcanzadoInput.value);
    const nuevoCapital = !isNaN(nuevoValor) ? nuevoValor : totalSimulado;

    actualizarDiferencia();

    const tbody = document.querySelector("#tabla tbody");
    const siguientes = Array.from(tbody.querySelectorAll("tr")).slice(index + 1);
    siguientes.forEach(tr => tr.remove());

    simular(nuevoCapital, index + 2);
  });
}

function guardarEstado() {
  const filas = document.querySelectorAll("#tabla tbody tr");
  const estado = {
    capital: document.getElementById("capital").value,
    meta: document.getElementById("meta").value,
    ganancia: document.getElementById("ganancia").value,
    apalancamiento: document.getElementById("apalancamiento").value,
    operaciones: Array.from(filas).map(fila => ({
      capital: fila.querySelector(".capital").textContent,
      ganancia: fila.querySelector(".ganancia").textContent,
      total: fila.querySelector(".total-simulado").textContent,
      totalAlcanzado: fila.querySelector(".total-alcanzado").value,
      diferencia: fila.querySelector(".diferencia").textContent,
      diferenciaClass: fila.querySelector(".diferencia").className,
      inversion: fila.querySelector(".inversion").textContent,
      tipo: fila.querySelector(".tipo-op").value,
      entrada: fila.querySelector(".precio-entrada").value,
      salida: fila.querySelector(".precio-salida").textContent,
      liquidacion: fila.querySelector(".precio-liquidacion").textContent
    }))
  };
  localStorage.setItem("estadoSimulador", JSON.stringify(estado));
   actualizarContadores();
}

function cargarEstado() {
  const data = localStorage.getItem("estadoSimulador");
  if (!data) return;
  const estado = JSON.parse(data);

  document.getElementById("capital").value = estado.capital;
  document.getElementById("meta").value = estado.meta;
  document.getElementById("ganancia").value = estado.ganancia;
  document.getElementById("apalancamiento").value = estado.apalancamiento;

  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";

  estado.operaciones.forEach((op, index) => {
    const fila = document.createElement("tr");
    if (parseFloat(op.total.replace("$", "")) >= parseFloat(estado.meta)) fila.classList.add("highlight");

    fila.innerHTML = `
      <td>${index + 1}</td>
      <td class="capital">${op.capital}</td>
      <td>${estado.ganancia}%</td>
      <td class="ganancia">${op.ganancia}</td>
      <td class="total-simulado">${op.total}</td>
      <td><input class="auto-input total-alcanzado" type="number" step="0.01" value="${op.totalAlcanzado ?? ''}"></td>
      <td class="${op.diferenciaClass}">${op.diferencia}</td>
      <td class="inversion">${op.inversion}</td>
      <td>
        <select class="tipo-op">
          <option value="long">Long</option>
          <option value="short">Short</option>
        </select>
      </td>
      <td><input class="auto-input precio-entrada" type="number" step="0.0001" value="${op.entrada ?? ''}"></td>
      <td class="precio-salida">${op.salida}</td>
      <td class="precio-liquidacion">${op.liquidacion}</td>
    `;
    tbody.appendChild(fila);

    fila.querySelector(".tipo-op").value = op.tipo;
    agregarEventos(index, parseFloat(estado.ganancia), parseFloat(estado.apalancamiento));
  });
 actualizarContadores();
}
function actualizarContadores() {
  const filas = document.querySelectorAll("#tabla tbody tr");

  const realizadas = Array.from(filas).filter(fila => {
    const input = fila.querySelector(".total-alcanzado");
    return input && input.value.trim() !== "";
  }).length;

  const total = filas.length;
  const faltan = total - realizadas;

  // Mostrar totales con faltantes
  document.getElementById("contadorTotal").textContent = `${total} (Faltan: ${faltan})`;
  document.getElementById("contadorRealizadas").textContent = realizadas;

  // Calcular la suma de "Total Alcanzado"
  let suma = 0;
  filas.forEach(fila => {
    const val = parseFloat(fila.querySelector(".total-alcanzado").value);
    if (!isNaN(val)) suma += val;
  });

  document.getElementById("totalAlcanzadoSum").textContent = `$${suma.toFixed(2)}`;
}

window.onload = cargarEstado;
</script>

</body>
</html>
