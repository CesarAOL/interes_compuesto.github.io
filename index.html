<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador Apalancado</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select {
      background: #222;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: #00b894;
      border: none;
      padding: 10px 20px;
      color: #fff;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #222;
    }

    tr.highlight {
      background: #14532d;
    }

    .diferencia.positivo {
      color: #00ff00;
    }

    .diferencia.negativo {
      color: #ff5555;
    }

    .diferencia.neutro {
      color: #888;
    }

    .auto-input {
      width: 100%;
      box-sizing: border-box;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Simulador Apalancado</h1>
  <div class="form-grid">
    <div>
      <label>Capital Inicial ($):</label>
      <input type="number" id="capital" step="0.01" />
    </div>
    <div>
      <label>Meta Final ($):</label>
      <input type="number" id="meta" step="0.01" />
    </div>
    <div>
      <label>Ganancia por Trade (%):</label>
      <input type="number" id="ganancia" step="0.01" />
    </div>
    <div>
      <label>Apalancamiento:</label>
      <input type="number" id="apalancamiento" step="0.01" />
    </div>
  </div>
  <button onclick="simular()">Simular</button>

  <table id="tabla">
    <thead>
      <tr>
        <th>#</th>
        <th>Capital ($)</th>
        <th>%</th>
        <th>Ganancia ($)</th>
        <th>Total Simulado ($)</th>
        <th>Total Alcanzado ($)</th>
        <th>Diferencia $</th>
        <th>Inversión × Apalancamiento ($)</th>
        <th>Tipo</th>
        <th>Precio Entrada</th>
        <th>Precio Salida</th>
        <th>Liquidación</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let datosOriginales = [];

    function calcularLiquidacion(precioEntrada, apalancamiento, tipo) {
      const margen = 1 / apalancamiento;
      const fee = 0.005;
      const riesgo = margen + fee;
      return tipo === "long"
        ? precioEntrada * (1 - riesgo)
        : precioEntrada * (1 + riesgo);
    }

    function calcularSalida(precioEntrada, apalancamiento, ganancia, tipo) {
      const cambio = (ganancia / 100) / apalancamiento;
      return tipo === "long"
        ? precioEntrada * (1 + cambio)
        : precioEntrada * (1 - cambio);
    }

    function simular(capitalInicialManual = null, filaInicio = 1) {
      const capitalInicial = capitalInicialManual ?? parseFloat(document.getElementById("capital").value);
      const meta = parseFloat(document.getElementById("meta").value);
      const gananciaPorcentaje = parseFloat(document.getElementById("ganancia").value);
      const apalancamiento = parseFloat(document.getElementById("apalancamiento").value);

      if (isNaN(capitalInicial) || isNaN(meta) || isNaN(gananciaPorcentaje) || isNaN(apalancamiento)) {
        alert("Por favor, completa todos los campos.");
        return;
      }

      let capital = capitalInicial;
      let fila = filaInicio;
      let tbody = document.querySelector("#tabla tbody");

      if (filaInicio === 1) {
        tbody.innerHTML = "";
        datosOriginales = [];
      }

      while (capital < meta) {
        const ganancia = capital * (gananciaPorcentaje / 100);
        const total = capital + ganancia;
        const inversion = capital * apalancamiento;

        datosOriginales.push({ capital, ganancia, total, inversion });

        const row = document.createElement("tr");
        if (total >= meta) row.classList.add("highlight");

        row.innerHTML = `
          <td>${fila}</td>
          <td class="capital">$${capital.toFixed(2)}</td>
          <td>${gananciaPorcentaje}%</td>
          <td class="ganancia">$${ganancia.toFixed(2)}</td>
          <td class="total-simulado">$${total.toFixed(2)}</td>
          <td><input class="auto-input total-alcanzado" type="number" step="0.01" placeholder="-"></td>
          <td class="diferencia neutro">-</td>
          <td class="inversion">$${inversion.toFixed(2)}</td>
          <td>
            <select class="tipo-op">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </td>
          <td><input class="auto-input precio-entrada" type="number" step="0.0001" placeholder="Ej: 1.2300"></td>
          <td class="precio-salida">-</td>
          <td class="precio-liquidacion">-</td>
        `;

        tbody.appendChild(row);
        fila++;
        capital = total;
      }

      agregarEventos(gananciaPorcentaje, apalancamiento);
      guardarEstado();
    }

    function agregarEventos(gananciaPorcentaje, apalancamiento) {
      const filas = document.querySelectorAll("#tabla tbody tr");

      filas.forEach((fila, i) => {
        const tipoSelect = fila.querySelector(".tipo-op");
        const entradaInput = fila.querySelector(".precio-entrada");
        const alcanzadoInput = fila.querySelector(".total-alcanzado");
        const diferenciaCell = fila.querySelector(".diferencia");
        const totalSimulado = parseFloat(fila.querySelector(".total-simulado").textContent.replace("$", ""));

        const actualizarPrecios = () => {
          const tipo = tipoSelect.value;
          const entrada = parseFloat(entradaInput.value);
          const salidaCell = fila.querySelector(".precio-salida");
          const liquiCell = fila.querySelector(".precio-liquidacion");

          if (!isNaN(entrada) && entrada > 0) {
            const salida = calcularSalida(entrada, apalancamiento, gananciaPorcentaje, tipo);
            const liqui = calcularLiquidacion(entrada, apalancamiento, tipo);
            salidaCell.textContent = `$${salida.toFixed(4)}`;
            liquiCell.textContent = `$${liqui.toFixed(4)}`;
          } else {
            salidaCell.textContent = "-";
            liquiCell.textContent = "-";
          }
          guardarEstado();
        };

        const actualizarDiferencia = () => {
          const valor = parseFloat(alcanzadoInput.value);
          if (isNaN(valor)) {
            diferenciaCell.textContent = "-";
            diferenciaCell.className = "diferencia neutro";
            return;
          }
          const diff = valor - totalSimulado;
          diferenciaCell.textContent = (diff >= 0 ? "+" : "") + "$" + diff.toFixed(2);
          diferenciaCell.className = "diferencia " + (diff > 0 ? "positivo" : diff < 0 ? "negativo" : "neutro");
          guardarEstado();
        };

        tipoSelect.addEventListener("change", actualizarPrecios);
        entradaInput.addEventListener("input", actualizarPrecios);
        alcanzadoInput.addEventListener("change", () => {
          const nuevoValor = parseFloat(alcanzadoInput.value);
          const nuevoCapital = !isNaN(nuevoValor) ? nuevoValor : totalSimulado;

          actualizarDiferencia();

          const tbody = document.querySelector("#tabla tbody");
          const siguientes = Array.from(tbody.querySelectorAll("tr")).slice(i + 1);
          siguientes.forEach(tr => tr.remove());
          datosOriginales.splice(i + 1);

          simular(nuevoCapital, i + 2);
        });
      });
    }

    function guardarEstado() {
      const filas = document.querySelectorAll("#tabla tbody tr");
      const estado = {
        capital: document.getElementById("capital").value,
        meta: document.getElementById("meta").value,
        ganancia: document.getElementById("ganancia").value,
        apalancamiento: document.getElementById("apalancamiento").value,
        filas: Array.from(filas).map(fila => ({
          totalAlcanzado: fila.querySelector(".total-alcanzado").value,
          tipo: fila.querySelector(".tipo-op").value,
          precioEntrada: fila.querySelector(".precio-entrada").value
        }))
      };
      localStorage.setItem("estadoSimulador", JSON.stringify(estado));
    }

    function cargarEstado() {
      const guardado = localStorage.getItem("estadoSimulador");
      if (!guardado) return;
      const estado = JSON.parse(guardado);

      document.getElementById("capital").value = estado.capital;
      document.getElementById("meta").value = estado.meta;
      document.getElementById("ganancia").value = estado.ganancia;
      document.getElementById("apalancamiento").value = estado.apalancamiento;

      simular(parseFloat(estado.capital));

      estado.filas.forEach((fila, i) => {
        const tr = document.querySelectorAll("#tabla tbody tr")[i];
        if (!tr) return;

        tr.querySelector(".total-alcanzado").value = fila.totalAlcanzado;
        tr.querySelector(".tipo-op").value = fila.tipo;
        tr.querySelector(".precio-entrada").value = fila.precioEntrada;
      });
    }

    window.addEventListener("load", cargarEstado);
  </script>
</body>
</html>
