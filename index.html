<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detalle de Inter√©s Compuesto</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #4CAF50;
    }

    .formulario {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .formulario input, .formulario select {
      padding: 0.5rem;
      font-size: 1rem;
      width: 180px;
    }

    button {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 0.3rem;
    }

    button:hover {
      background-color: #45a049;
    }

    .resumen {
      margin: 1rem auto;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .detalle-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .detalle-box {
      background: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 280px;
      transition: transform 0.2s;
    }

    .detalle-box:hover {
      transform: scale(1.02);
    }

    .detalle-box p {
      margin: 0.2rem 0;
    }

    .detalle-box input {
      margin-top: 0.4rem;
      width: 100%;
      padding: 0.4rem;
    }

    .mensaje-diferencia {
      font-size: 0.95rem;
      margin-top: 0.4rem;
    }

    .negativo {
      color: red;
    }

    .positivo {
      color: green;
    }

    .resumen-animado {
      animation: pop 0.3s ease-in-out;
    }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  
  .mensaje-diferencia {
    font-size: 0.95rem;
    margin-top: 0.4rem;
    padding: 0.4rem;
    border-radius: 4px;
  }

  .mensaje-diferencia.positivo {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #66bb6a;
  }

  .mensaje-diferencia.negativo {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
  }

</style>
</head>
<body>
  <h1>Detalle de Inter√©s Compuesto</h1>

  <div class="formulario">
    <input type="number" id="capital" placeholder="Capital Inicial" />
    <input type="number" id="interes" placeholder="Inter√©s Diario (%)" step="0.01" />
    <input type="number" id="meses" placeholder="N√∫mero de Meses" />
    <select id="moneda">
      <option value="S/">Soles (S/)</option>
      <option value="$">D√≥lares ($)</option>
    </select>
    <button onclick="generarDetalle()">Generar Detalle</button>
    <button onclick="exportarExcel()">Exportar Excel</button>
  </div>

  <div class="resumen" id="resumenEstimado">Monto Final Estimado: S/ 0.00</div>
  <div class="resumen" id="resumenReal">Monto Real Alcanzado: S/ 0.00</div>
  <div class="resumen" id="contadorResultados">Meses Positivos: 0 | Meses Negativos: 0</div>

  <div class="detalle-container" id="detalleContainer"></div>

  <script>
    const STORAGE_KEY = "detalle_interes_compuesto_v2";

    function formatoMoneda(valor, simbolo) {
      return `${simbolo} ${valor.toFixed(2)}`;
    }

    function generarDetalle() {
      localStorage.removeItem(STORAGE_KEY);

      const capital = parseFloat(document.getElementById('capital').value);
      const interesDiario = parseFloat(document.getElementById('interes').value) / 100;
      const meses = parseInt(document.getElementById('meses').value);
      const simbolo = document.getElementById('moneda').value;

      if (isNaN(capital) || isNaN(interesDiario) || isNaN(meses)) {
        alert('Por favor completa todos los campos.');
        return;
      }

      const detalleContainer = document.getElementById('detalleContainer');
      detalleContainer.innerHTML = '';

      let saldo = capital;
      const dias = 30;
      let inputsData = [];

      for (let i = 0; i < meses; i++) {
        const interesMensual = saldo * interesDiario * dias;
        const estimado = saldo + interesMensual;

        const box = document.createElement('div');
        box.className = 'detalle-box';

        box.innerHTML = `
          <h3>Mes ${i + 1}</h3>
          <p>Saldo Inicial: ${formatoMoneda(saldo, simbolo)}</p>
          <p>Inter√©s: ${formatoMoneda(interesMensual, simbolo)}</p>
          <p>Estimado: ${formatoMoneda(estimado, simbolo)}</p>
          <input type="number" placeholder="Monto Real a Poner" data-indice="${i}" data-estimado="${estimado}" />
          <div class="mensaje-diferencia"></div>
        `;

        detalleContainer.appendChild(box);

        inputsData.push({ estimado, valor: '', diferencia: '', clase: '' });
        saldo = estimado;
      }

      document.getElementById('resumenEstimado').textContent = `Monto Final Estimado: ${formatoMoneda(saldo, simbolo)}`;
      document.getElementById('resumenReal').textContent = `Monto Real Alcanzado: ${formatoMoneda(0, simbolo)}`;
      document.getElementById('contadorResultados').textContent = `Meses Positivos: 0 | Meses Negativos: 0`;

      const inputs = document.querySelectorAll('input[data-estimado]');
      inputs.forEach(input => {
        input.addEventListener('input', () => actualizarDiferencia(input));
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify({ capital, interes: interesDiario * 100, meses, simbolo, inputsData }));
    }

    function actualizarDiferencia(input) {
      const datos = JSON.parse(localStorage.getItem(STORAGE_KEY));
      const inputs = document.querySelectorAll('input[data-estimado]');
      const detalleBoxes = document.querySelectorAll('.detalle-box');
      const interesDiario = parseFloat(document.getElementById('interes').value) / 100;
      const dias = 30;
      const simbolo = document.getElementById('moneda').value;
      let saldo = parseFloat(document.getElementById('capital').value);

      for (let i = 0; i < inputs.length; i++) {
        const box = detalleBoxes[i];
        const inputReal = box.querySelector('input');
        const mensaje = box.querySelector('.mensaje-diferencia');

        if (i > 0) {
          const anteriorReal = parseFloat(detalleBoxes[i - 1].querySelector('input').value);
          if (!isNaN(anteriorReal)) saldo = anteriorReal;
        }

        const interesMensual = saldo * interesDiario * dias;
        const estimado = saldo + interesMensual;

        box.querySelector('p:nth-child(2)').textContent = `Saldo Inicial: ${formatoMoneda(saldo, simbolo)}`;
        box.querySelector('p:nth-child(3)').textContent = `Inter√©s: ${formatoMoneda(interesMensual, simbolo)}`;
        box.querySelector('p:nth-child(4)').textContent = `Estimado: ${formatoMoneda(estimado, simbolo)}`;
        inputReal.setAttribute('data-estimado', estimado);

        const real = parseFloat(inputReal.value);
        if (!isNaN(real)) {
          const diferencia = real - estimado;
          const porcentaje = (diferencia / estimado) * 100;
          const clase = diferencia < 0 ? 'negativo' : 'positivo';
          mensaje.textContent = `Diferencia: ${formatoMoneda(diferencia, simbolo)} (${porcentaje.toFixed(1)}%)`;
          mensaje.className = `mensaje-diferencia ${clase}`;
          datos.inputsData[i] = { estimado, valor: real, diferencia, clase };
        } else {
          mensaje.textContent = '';
mensaje.className = 'mensaje-diferencia'; // ‚Üê elimina clases de color
datos.inputsData[i] = { estimado, valor: '', diferencia: '', clase: '' };

        }

        saldo = estimado;
      }

      let ultimoReal = 0;
      for (let i = inputs.length - 1; i >= 0; i--) {
        const val = parseFloat(inputs[i].value);
        if (!isNaN(val)) {
          ultimoReal = val;
          break;
        }
      }

      document.getElementById('resumenReal').textContent = `Monto Real Alcanzado: ${formatoMoneda(ultimoReal, simbolo)}`;
      document.getElementById('resumenReal').classList.add('resumen-animado');
      setTimeout(() => document.getElementById('resumenReal').classList.remove('resumen-animado'), 800);

      let positivos = 0, negativos = 0;
      inputs.forEach((inp) => {
        const est = parseFloat(inp.getAttribute('data-estimado'));
        const val = parseFloat(inp.value);
        if (!isNaN(val)) {
          if (val >= est) positivos++;
          else negativos++;
        }
      });

      document.getElementById('contadorResultados').textContent = `Meses Positivos: ${positivos} | Meses Negativos: ${negativos}`;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
    }

    function exportarExcel() {
      const datos = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (!datos) {
        alert("No hay datos para exportar.");
        return;
      }

      const detalleBoxes = document.querySelectorAll('.detalle-box');
      const simbolo = datos.simbolo;
      const filas = [
        ["Mes", "Saldo Inicial", "Inter√©s", "Estimado", "Real", "Diferencia", "Porcentaje"]
      ];

      detalleBoxes.forEach((box, i) => {
        const saldoInicial = parseFloat(box.querySelector('p:nth-child(2)').textContent.split(": ")[1].replace(simbolo, "").trim());
        const interes = parseFloat(box.querySelector('p:nth-child(3)').textContent.split(": ")[1].replace(simbolo, "").trim());
        const estimado = parseFloat(box.querySelector('p:nth-child(4)').textContent.split(": ")[1].replace(simbolo, "").trim());
        const realInput = box.querySelector('input').value;
        const real = realInput ? parseFloat(realInput) : null;

        let diferencia = "", porcentaje = "";
        if (real !== null) {
          diferencia = real - estimado;
          porcentaje = (diferencia / estimado) || 0;
        }

        filas.push([
          `Mes ${i + 1}`,
          saldoInicial,
          interes,
          estimado,
          real !== null ? real : "",
          diferencia !== "" ? diferencia : "",
          porcentaje !== "" ? porcentaje : ""
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(filas);

      const currencyFormat = '"'+simbolo+'" #,##0.00';
      const percentFormat = '0.0%';

      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let C = range.s.c + 1; C <= range.e.c; ++C) {
        for (let R = range.s.r + 1; R <= range.e.r; ++R) {
          const cell_address = { c: C, r: R };
          const cell_ref = XLSX.utils.encode_cell(cell_address);
          const cell = ws[cell_ref];
          if (!cell) continue;

          if ([1,2,3,4,5].includes(C)) {
            cell.z = currencyFormat;
            cell.t = "n";
          } else if (C === 6) {
            cell.z = percentFormat;
            cell.t = "n";
          }
        }
      }

      for (let C = 0; C <= 6; C++) {
        const cell_ref = XLSX.utils.encode_cell({ c: C, r: 0 });
        if (ws[cell_ref]) {
          ws[cell_ref].s = { font: { bold: true } };
        }
      }

      ws['!cols'] = [
        { wch: 10 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 },
        { wch: 12 }
      ];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Detalle");
      XLSX.writeFile(wb, "detalle_interes_compuesto.xlsx");
    }

    window.addEventListener('DOMContentLoaded', () => {
      const datos = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (datos) {
        document.getElementById('capital').value = datos.capital;
        document.getElementById('interes').value = datos.interes;
        document.getElementById('meses').value = datos.meses;
        document.getElementById('moneda').value = datos.simbolo;
        generarDetalle();

        const inputs = document.querySelectorAll('input[data-estimado]');
        datos.inputsData.forEach((d, i) => {
          inputs[i].value = d.valor;
        });
        inputs.forEach(input => {
          input.dispatchEvent(new Event('input'));
        });
      }
    });
  </script>
</body>
<!-- Bot√≥n flotante -->
<button id="btnFlotante" title="Calculadora de Apalancamiento">üìà</button>

<!-- Panel lateral con campos flotantes -->
<div id="panelCalculadora">
  <div id="cerrarPanel">‚úñ</div>
  <h2>Calculadora Apalancamiento</h2>

  <div class="campo-flotante">
    <select id="tipoOperacion" required>
      <option value="long">üìà Long (sube)</option>
      <option value="short">üìâ Short (baja)</option>
    </select>
  </div>

  <div class="campo-flotante">
    <input type="number" id="precioEntrada" required placeholder=" " />
    <label for="precioEntrada">Precio de entrada ($)</label>
  </div>

  <div class="campo-flotante">
    <input type="number" id="montoInvertido" required placeholder=" " />
    <label for="montoInvertido">Monto invertido ($)</label>
  </div>

  <div class="campo-flotante">
    <input type="number" id="apalancamiento" required placeholder=" " />
    <label for="apalancamiento">Apalancamiento (x)</label>
  </div>

  <div class="campo-flotante">
    <input type="number" id="gananciaDeseada" required placeholder=" " />
    <label for="gananciaDeseada">Ganancia deseada ($)</label>
  </div>

  <button onclick="calcularSalida()">Calcular</button>

  <div id="resultadoApalancamiento"></div>
</div>

<!-- ESTILOS -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

  :root {
    --color-principal: #0d47a1;
    --color-verde: #00c853;
    --color-rojo: #d50000;
    --color-panel: #121212;
    --color-texto: #ffffff;
    --color-input: #1e1e1e;
    --borde-input: #444;
    --sombra-suave: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  * {
    box-sizing: border-box;
  }

  #btnFlotante {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: var(--color-principal);
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 50%;
    font-size: 1.6rem;
    cursor: pointer;
    z-index: 999;
    box-shadow: var(--sombra-suave);
    transition: all 0.3s ease;
  }

  #btnFlotante:hover {
    transform: scale(1.08);
    background: #1565c0;
  }

  #panelCalculadora {
    position: fixed;
    top: 0;
    right: -320px;
    width: 280px;
    height: 100%;
    background: var(--color-panel);
    color: var(--color-texto);
    box-shadow: var(--sombra-suave);
    padding: 1.5rem 1rem;
    transition: right 0.4s ease;
    z-index: 998;
    backdrop-filter: blur(8px);
    font-family: 'Roboto', sans-serif;
    overflow-y: auto;
    border-left: 2px solid #1e1e1e;
    border-radius: 0; /* ‚Üê sin redondeo para estar completamente pegado */
  }

  #panelCalculadora h2 {
    margin-top: 0;
    font-size: 1.2rem;
    margin-bottom: 1rem;
    text-align: center;
    color: #ffffff;
    border-bottom: 1px solid #333;
    padding-bottom: 0.4rem;
  }

  .campo-flotante {
    position: relative;
    margin-bottom: 1.3rem;
  }

  .campo-flotante input,
  .campo-flotante select {
    width: 100%;
    padding: 0.8rem 0.6rem;
    font-size: 0.95rem;
    background: var(--color-input);
    border: 1px solid var(--borde-input);
    color: white;
    border-radius: 5px;
    outline: none;
    font-family: 'Roboto', sans-serif;
  }

  .campo-flotante label {
    position: absolute;
    top: 50%;
    left: 0.6rem;
    transform: translateY(-50%);
    font-size: 0.9rem;
    color: #aaa;
    pointer-events: none;
    transition: 0.2s ease all;
    background-color: transparent;
  }

  .campo-flotante input:focus + label,
  .campo-flotante input:not(:placeholder-shown) + label,
  .campo-flotante select:focus + label,
  .campo-flotante select:valid + label {
    top: -0.6rem;
    left: 0.5rem;
    background-color: var(--color-panel);
    padding: 0 0.3rem;
    font-size: 0.7rem;
    color: #aaa;
  }

  #panelCalculadora button {
    background-color: var(--color-principal);
    border: none;
    color: white;
    padding: 0.6rem;
    width: 100%;
    font-size: 1rem;
    margin-top: 0.3rem;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.3s ease;
  }

  #panelCalculadora button:hover {
    background-color: #1976d2;
  }

  #cerrarPanel {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 1.2rem;
    cursor: pointer;
    color: #888;
    transition: color 0.3s;
  }

  #cerrarPanel:hover {
    color: #fff;
  }

  #resultadoApalancamiento {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.4s ease;
    font-size: 0.95rem;
    font-family: 'Roboto', sans-serif;
  }

  #resultadoApalancamiento.mostrar {
    opacity: 1;
    transform: translateY(0);
  }

  .positivo {
    background-color: #2e7d32;
    color: #e8f5e9;
    border: 1px solid #66bb6a;
  }

  .negativo {
    background-color: #8e1e1e;
    color: #ffeaea;
    border: 1px solid #f28b82;
  }

  .mensaje-error {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
    font-weight: normal;
  }
</style>

<!-- SCRIPTS -->
<script>
  const btnFlotante = document.getElementById('btnFlotante');
  const panel = document.getElementById('panelCalculadora');
  const cerrar = document.getElementById('cerrarPanel');
  const resultado = document.getElementById('resultadoApalancamiento');

  btnFlotante.onclick = () => {
    panel.style.right = '0px'; // ‚Üê ahora se pega totalmente al borde derecho
    document.addEventListener('click', cerrarPorClickFuera);
  };

  cerrar.onclick = cerrarPanel;

  function cerrarPanel() {
    panel.style.right = '-320px';
    resultado.innerHTML = '';
    resultado.className = '';
    resultado.classList.remove('mostrar');
    document.removeEventListener('click', cerrarPorClickFuera);
    limpiarCampos();
  }

  function cerrarPorClickFuera(event) {
    if (!panel.contains(event.target) && event.target !== btnFlotante) {
      cerrarPanel();
    }
  }

  function limpiarCampos() {
    document.getElementById('precioEntrada').value = '';
    document.getElementById('montoInvertido').value = '';
    document.getElementById('apalancamiento').value = '';
    document.getElementById('gananciaDeseada').value = '';
    document.getElementById('tipoOperacion').value = 'long';
  }

  function calcularSalida() {
    const tipo = document.getElementById('tipoOperacion').value;
    const entrada = parseFloat(document.getElementById('precioEntrada').value);
    const monto = parseFloat(document.getElementById('montoInvertido').value);
    const apalancamiento = parseFloat(document.getElementById('apalancamiento').value);
    const ganancia = parseFloat(document.getElementById('gananciaDeseada').value);

    if (isNaN(entrada) || isNaN(monto) || isNaN(apalancamiento) || isNaN(ganancia)) {
      resultado.innerHTML = "‚ö†Ô∏è Completa todos los campos correctamente.";
      resultado.className = "mensaje-error mostrar";
      return;
    }

    const posicion = monto * apalancamiento;
    const variacion = (ganancia / posicion) * entrada;
    const salida = tipo === "long" ? entrada + variacion : entrada - variacion;
    const roi = (ganancia / monto) * 100;

    resultado.innerHTML = `
      Tipo: <strong>${tipo === "long" ? "Largo üìà" : "Corto üìâ"}</strong><br>
      Precio de salida:<br><strong>$${salida.toFixed(2)}</strong><br>
      ROI sobre capital:<br><strong>${roi.toFixed(2)}%</strong>
    `;

    resultado.className = `mostrar ${roi >= 0 ? 'positivo' : 'negativo'}`;
  }
</script>


</html>
